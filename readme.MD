# Pico W WebSockets

A lightweight framework para Raspberry¬†Pi Pico W que simplifica:

* **WebSockets** sobre LWIP (bare‚Äëmetal, thread‚Äësafe)
* **HTTP server** minimalista com rotas din√¢micas
* **Access Point** configur√°vel (SSID, senha, canal)
* **Captive portal** (redirecionamento 302)

Funciona em *bare-metal* com polling (`cyw43_arch_poll()`), mas tamb√©m pode ser integrado ao FreeRTOS criando uma task dedicada para rede (usar `pico_cyw43_arch_lwip_threadsafe_background()` ou port SMP para RP2040).

---

## üìÇ Estrutura do reposit√≥rio

```
‚îú‚îÄ‚îÄ CMakeLists.txt          # Configura√ß√£o do Pico SDK
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ main.c              # Exemplo de uso e inicializa√ß√£o
‚îÇ   ‚îú‚îÄ‚îÄ ap.h / ap.c         # Setup de Access Point (canal, SSID, senha)
‚îÇ   ‚îú‚îÄ‚îÄ http.h / http.c     # Framework HTTP / rotas / captive portal
‚îÇ   ‚îú‚îÄ‚îÄ websocket.h / websocket.c  # WebSocket handshake, parse e callbacks
‚îÇ   ‚îú‚îÄ‚îÄ encrypt.h           # SHA1 & Base64 helpers
‚îÇ   ‚îî‚îÄ‚îÄ routes/
‚îÇ       ‚îú‚îÄ‚îÄ index.h         # P√°gina Chat
‚îÇ       ‚îú‚îÄ‚îÄ mouse.h         # P√°gina Mouse Tracker
‚îÇ       ‚îî‚îÄ‚îÄ status.h        # P√°gina Uptime
‚îî‚îÄ‚îÄ README.md
```

---

## üöÄ Objetivo

Prover, com **poucas linhas de c√≥digo**, um servidor HTTP + WebSockets no Pico¬†W, incluindo:

1. **AP Wi‚ÄëFi**: escolha de SSID, senha e canal.
2. **Captive Portal**: redireciona requisi√ß√µes ‚Äúgolden URLs‚Äù t√≠picas de captive-detect.
3. **Rotas HTTP** din√¢micas (GET ‚Üí handler que preenche buffer).
4. **WebSockets**: handshake, parsing de frames, callbacks de eventos e broadcast.
5. **Extras**: p√°ginas de exemplo ‚Äî chat, mouse tracker e status de uptime.

---

## üìù Exemplo de uso (`src/main.c`)

```c
#include "pico/stdlib.h"
#include "ap.h"
#include "http.h"
#include "websocket.h"

// P√°ginas de exemplo
#include "routes/index.h"
#include "routes/mouse.h"
#include "routes/status.h"

int main() {
    stdio_init_all();

    // 1) Inicializa AP: SSID, senha e canal
    setup_access_point("MyPicoAP", "senha123", "pico.local");

    // 2) Registra rotas HTTP
    add_http_route("/",       create_index_response);
    add_http_route("/index",  create_index_response);
    add_http_route("/mouse",  create_mouse_response);
    add_http_route("/status", create_status_response);

    // 3) Habilita WebSocket em rotas HTTP via esquema ‚ÄúUpgrade: websocket‚Äù
    add_new_schema_route("websocket", websocket_schema_upgrade);

    // 4) Callbacks de eventos WS
    ws_add_on_upgrade_handler(on_upgrade);
    ws_add_on_text_handler   (on_text);
    ws_add_on_close_handler  (on_close);
    ws_add_on_ping_handler   (on_ping);
    ws_add_on_pong_handler   (on_pong);

    // 5) Sobe o servidor e entra no loop
    start_http_server();

    absolute_time_t last = get_absolute_time();
    while (true) {
        cyw43_arch_poll();

        // Envia status (uptime) a cada 1¬†segundo
        if (absolute_time_diff_us(last, get_absolute_time()) >= 1000000) {
            last = get_absolute_time();
            send_uptime_to_all();
        }
        sleep_ms(5);
    }
}
```

---

## üîß Principais blocos de c√≥digo

### Access Point

```c
void setup_access_point(const char *ssid,
                        const char *password,
                        const char *hostname);
```

* **ssid**: nome da rede
* **password**: deixe `NULL` para rede aberta
* **hostname**: dom√≠nio local (ex.: `pico.local`)

### HTTP + Rotas

```c
typedef void(*route_response_handler_t)(char* buf, size_t len);

// Registra rota GET ‚Üí handler(buffer, len)
void add_http_route(const char* path,
                    route_response_handler_t handler);

// Inicia o servidor HTTP na porta¬†80
void start_http_server(void);
```

No *handler*, preencha `buf` com cabe√ßalhos + body:

```c
void create_index_response(char* buf, size_t len) {
    snprintf(buf, len, HTTP_HEADER INDEX_BODY);
}
```

### Captive Portal

Monitora requisi√ß√µes em *golden URLs*:

```c
const char* captive_site_routes[] = {
  "GET /generate_204",
  "GET /hotspot-detect.html",
  "GET /connecttest.txt",
  "GET /redirect"
};
```

e envia *302 Found* para `http://<ap_ip>/`.

### WebSocket

#### Handshake e registro de cliente

```c
int websocket_schema_upgrade(char *payload,
                             struct tcp_pcb *tpcb,
                             struct pbuf *p);
```

#### Callbacks de eventos

```c
ws_add_on_upgrade_handler(ws_message_handler cb);
ws_add_on_text_handler(ws_message_handler cb);
ws_add_on_close_handler(ws_message_handler cb);
ws_add_on_ping_handler(ws_message_handler cb);
ws_add_on_pong_handler(ws_message_handler cb);
```

#### Envio de mensagens

```c
void ws_send_message(ws_client_tpcb wc,
                     WS_OPCODE opcode,
                     uint8_t *msg, size_t len);

void ws_send_to_all_clients(const char* route,
                            WS_OPCODE opcode,
                            uint8_t *msg, size_t len);
```

#### Utilit√°rios

```c
char *ws_get_client_ip(ws_client_tpcb wc, char *buf, size_t buflen);
char *ws_get_client_route(ws_client_tpcb wc);
```

---

## üñ•Ô∏è Rotas de exemplo

| Rota      | P√°gina            | Descri√ß√£o                                               |
| --------- | ----------------- | ------------------------------------------------------- |
| `/`       | **Chat**          | Chat simples com input e log de mensagens.              |
| `/mouse`  | **Mouse Tracker** | Envia coords do mouse para o Pico e exibe no browser.   |
| `/status` | **Uptime Status** | Atualiza tempo de execu√ß√£o via WebSocket em tempo real. |

---

## üîê Criptografia

* **Base64** (`b64.h`) por‚ÄØRen√© Nyffenegger (public domain)
* **SHA1** (`tenysha1.h`) por‚ÄØSteve Reid (public domain)

Usadas no c√°lculo de `Sec-WebSocket-Accept` durante o handshake.

---

## üíæ Build & Deploy

1. Clone o reposit√≥rio:

   ```bash
   git clone https://github.com/usuario/pico-w-websockets.git
   cd pico-w-websockets
   ```
2. Configure o Pico SDK (`PICO_SDK_PATH`) e crie build:

   ```bash
   mkdir build && cd build
   cmake .. -DPICO_SDK_PATH=~/pico-sdk
   make
   ```
3. Arraste o `.uf2` para a unidade *RPI-RP2* no Pico¬†W.

---

## ü§ù Contribui√ß√µes

Sinta‚Äëse √† vontade para abrir **issues**, enviar **pull requests** ou sugerir **novas rotas** e **funcionalidades**!

---

**Autores:**
‚Äì Ataniel Silva Santos Segundo
‚Äì Ren√© Nyffenegger (`b64.h`)
‚Äì Steve Reid (`tenysha1.h`)
